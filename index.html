<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáπüá≠ Thailand 50 Tawi Tax Document Generator Pro</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .section-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .upload-area:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            background: #e8edff;
            border-color: #4c5fd7;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .preview-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .signature-container {
            margin-top: 20px;
        }
        
        #signaturePad {
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            width: 100%;
            max-width: 500px;
            height: 200px;
            margin: 0 auto;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .document-preview {
            background: white;
            padding: 40px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .document-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
        }
        
        .document-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .document-subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
        }
        
        .info-value {
            color: #333;
        }
        
        #fileInput {
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáπüá≠ Thailand 50 Tawi Tax Document Generator Pro</h1>
            <p>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (50 ‡∏ó‡∏ß‡∏¥) - Professional Edition</p>
        </div>
        
        <!-- Company Information Section -->
        <div class="section">
            <div class="section-title">
                <span>üè¢</span>
                <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó / Company Information</span>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó / Company Name *</label>
                    <input type="text" id="companyName" placeholder="ABC Company Limited" required>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ / Tax ID *</label>
                    <input type="text" id="companyTaxId" placeholder="0123456789012" maxlength="13" required>
                </div>
                <div class="form-group">
                    <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / Address *</label>
                    <textarea id="companyAddress" rows="2" placeholder="123 Business Road, Bangkok 10110" required></textarea>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / Phone</label>
                    <input type="tel" id="companyPhone" placeholder="02-123-4567">
                </div>
                <div class="form-group">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• / Email</label>
                    <input type="email" id="companyEmail" placeholder="contact@company.com">
                </div>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="saveCompanyInfo()">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó / Save Company Info
                </button>
                <button class="btn btn-secondary" onclick="loadCompanyInfo()">
                    üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó / Load Company Info
                </button>
            </div>
        </div>
        
        <!-- Income Type Selection -->
        <div class="section">
            <div class="section-title">
                <span>üí∞</span>
                <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ / Income Type</span>
            </div>
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ / Select Income Type *</label>
                <select id="incomeType" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / Select Type --</option>
                    <option value="1">1. ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á / Salary & Wages</option>
                    <option value="2">2. ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ / Fee, Commission</option>
                    <option value="3">3. ‡∏Ñ‡πà‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå / Royalty</option>
                    <option value="4">4. ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏• / Interest, Dividend</option>
                    <option value="5">5. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô / Rental Income</option>
                    <option value="6">6. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / Prize, Discount</option>
                    <option value="7">7. ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á / Construction Contract</option>
                    <option value="8">8. ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ / Other Income</option>
                </select>
            </div>
        </div>
        
        <!-- Digital Signature Section -->
        <div class="section">
            <div class="section-title">
                <span>‚úçÔ∏è</span>
                <span>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• / Digital Signature</span>
            </div>
            <div class="signature-container">
                <canvas id="signaturePad"></canvas>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearSignature()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô / Clear
                    </button>
                    <button class="btn btn-secondary" onclick="saveSignature()">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô / Save
                    </button>
                </div>
            </div>
        </div>
        
        <!-- CSV Upload Section -->
        <div class="section">
            <div class="section-title">
                <span>üì§</span>
                <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV / Upload CSV File</span>
            </div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h3>
                <p>‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                <p style="color: #888; font-size: 0.9em; margin-top: 10px;">
                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: .csv (UTF-8 encoding)
                </p>
            </div>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
        </div>
        
        <!-- Alert Messages -->
        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-error"></div>
        <div id="alertInfo" class="alert alert-info"></div>
        
        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <!-- Data Preview Section -->
        <div class="section hidden" id="previewSection">
            <div class="section-title">
                <span>üëÅÔ∏è</span>
                <span>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Data Preview</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / Name</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / Tax ID</th>
                            <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / Address</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ / Income</th>
                            <th>‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å / Tax Withheld</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            
            <div class="button-group">
                <button class="btn btn-success" onclick="generateAllDocuments()">
                    üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / Generate All PDFs
                </button>
                <button class="btn btn-primary" onclick="generateSinglePDF()">
                    üìù ‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF (‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å) / Test First PDF
                </button>
            </div>
        </div>
        
        <!-- Document Preview Section (Hidden by default) -->
        <div id="documentPreview" class="hidden"></div>
    </div>

    <script>
        // Initialize Signature Pad
        const canvas = document.getElementById('signaturePad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        // Resize canvas
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        
        let csvData = [];
        let savedSignature = null;
        
        // Drag and Drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV / Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    showAlert('success', `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${csvData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / File loaded successfully! Found ${csvData.length} records`);
                    showPreview();
                } catch (error) {
                    showAlert('error', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ / Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length >= 5) {
                    csvData.push({
                        name: values[0],
                        taxId: values[1],
                        address: values[2],
                        income: parseFloat(values[3]) || 0,
                        taxWithheld: parseFloat(values[4]) || 0
                    });
                }
            }
        }
        
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewBody = document.getElementById('previewBody');
            
            previewBody.innerHTML = '';
            csvData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.name}</td>
                    <td>${row.taxId}</td>
                    <td>${row.address}</td>
                    <td>${formatCurrency(row.income)}</td>
                    <td>${formatCurrency(row.taxWithheld)}</td>
                `;
                previewBody.appendChild(tr);
            });
            
            previewSection.classList.remove('hidden');
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB'
            }).format(amount);
        }
        
        function showAlert(type, message) {
            const alertId = type === 'success' ? 'alertSuccess' : 
                           type === 'error' ? 'alertError' : 'alertInfo';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function clearSignature() {
            signaturePad.clear();
            savedSignature = null;
        }
        
        function saveSignature() {
            if (signaturePad.isEmpty()) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô / Please sign first');
                return;
            }
            savedSignature = signaturePad.toDataURL();
            showAlert('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß / Signature saved');
        }
        
        function saveCompanyInfo() {
            const companyInfo = {
                name: document.getElementById('companyName').value,
                taxId: document.getElementById('companyTaxId').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value
            };
            
            if (!companyInfo.name || !companyInfo.taxId || !companyInfo.address) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô / Please fill required fields');
                return;
            }
            
            localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
            showAlert('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÅ‡∏•‡πâ‡∏ß / Company info saved');
        }
        
        function loadCompanyInfo() {
            const saved = localStorage.getItem('companyInfo');
            if (saved) {
                const companyInfo = JSON.parse(saved);
                document.getElementById('companyName').value = companyInfo.name || '';
                document.getElementById('companyTaxId').value = companyInfo.taxId || '';
                document.getElementById('companyAddress').value = companyInfo.address || '';
                document.getElementById('companyPhone').value = companyInfo.phone || '';
                document.getElementById('companyEmail').value = companyInfo.email || '';
                showAlert('success', '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÅ‡∏•‡πâ‡∏ß / Company info loaded');
            } else {
                showAlert('info', '‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ / No saved data found');
            }
        }
        
        function validateInputs() {
            const companyName = document.getElementById('companyName').value;
            const companyTaxId = document.getElementById('companyTaxId').value;
            const companyAddress = document.getElementById('companyAddress').value;
            const incomeType = document.getElementById('incomeType').value;
            
            if (!companyName || !companyTaxId || !companyAddress) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö / Please fill all company information');
                return false;
            }
            
            if (!incomeType) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ / Please select income type');
                return false;
            }
            
            if (csvData.length === 0) {
                showAlert('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV / Please upload CSV file');
                return false;
            }
            
            return true;
        }
        
        async function generateSinglePDF() {
            if (!validateInputs()) return;
            
            showAlert('info', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ó‡∏î‡∏™‡∏≠‡∏ö... / Generating test PDF...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const employee = csvData[0];
                const companyName = document.getElementById('companyName').value;
                const companyTaxId = document.getElementById('companyTaxId').value;
                const companyAddress = document.getElementById('companyAddress').value;
                const incomeType = document.getElementById('incomeType').value;
                const incomeTypeText = document.getElementById('incomeType').options[document.getElementById('incomeType').selectedIndex].text;
                
                // Create document content
                let yPos = 20;
                
                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('TAX WITHHOLDING CERTIFICATE', 105, yPos, { align: 'center' });
                yPos += 10;
                doc.setFontSize(16);
                doc.text('(Section 50 Bis)', 105, yPos, { align: 'center' });
                yPos += 15;
                
                // Company Info
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('PAYER INFORMATION:', 20, yPos);
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.text(`Company: ${companyName}`, 20, yPos);
                yPos += 6;
                doc.text(`Tax ID: ${companyTaxId}`, 20, yPos);
                yPos += 6;
                doc.text(`Address: ${companyAddress}`, 20, yPos);
                yPos += 12;
                
                // Employee Info
                doc.setFont(undefined, 'bold');
                doc.text('PAYEE INFORMATION:', 20, yPos);
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.text(`Name: ${employee.name}`, 20, yPos);
                yPos += 6;
                doc.text(`Tax ID: ${employee.taxId}`, 20, yPos);
                yPos += 6;
                doc.text(`Address: ${employee.address}`, 20, yPos);
                yPos += 12;
                
                // Income Details
                doc.setFont(undefined, 'bold');
                doc.text('INCOME DETAILS:', 20, yPos);
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.text(`Income Type: ${incomeTypeText}`, 20, yPos);
                yPos += 6;
                doc.text(`Income Amount: ${formatCurrency(employee.income)}`, 20, yPos);
                yPos += 6;
                doc.text(`Tax Withheld: ${formatCurrency(employee.taxWithheld)}`, 20, yPos);
                yPos += 6;
                doc.text(`Tax Rate: ${((employee.taxWithheld / employee.income) * 100).toFixed(2)}%`, 20, yPos);
                yPos += 15;
                
                // Date
                const today = new Date().toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                doc.text(`Issue Date: ${today}`, 20, yPos);
                yPos += 15;
                
                // Signature
                if (savedSignature) {
                    doc.addImage(savedSignature, 'PNG', 20, yPos, 50, 20);
                    yPos += 22;
                }
                doc.text('_________________________', 20, yPos);
                yPos += 6;
                doc.text('Authorized Signature', 20, yPos);
                
                // Save PDF
                doc.save(`50Tawi_${employee.name.replace(/\s+/g, '_')}_Test.pdf`);
                showAlert('success', '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! / Test PDF generated successfully!');
                
            } catch (error) {
                showAlert('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / Error: ' + error.message);
                console.error(error);
            }
        }
        
        async function generateAllDocuments() {
            if (!validateInputs()) return;
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            
            showAlert('info', `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${csvData.length} ‡πÑ‡∏ü‡∏•‡πå... / Generating ${csvData.length} PDFs...`);
            
            try {
                const { jsPDF } = window.jspdf;
                const companyName = document.getElementById('companyName').value;
                const companyTaxId = document.getElementById('companyTaxId').value;
                const companyAddress = document.getElementById('companyAddress').value;
                const incomeType = document.getElementById('incomeType').value;
                const incomeTypeText = document.getElementById('incomeType').options[document.getElementById('incomeType').selectedIndex].text;
                
                for (let i = 0; i < csvData.length; i++) {
                    const employee = csvData[i];
                    const doc = new jsPDF();
                    
                    // Create document content (same as single PDF)
                    let yPos = 20;
                    
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text('TAX WITHHOLDING CERTIFICATE', 105, yPos, { align: 'center' });
                    yPos += 10;
                    doc.setFontSize(16);
                    doc.text('(Section 50 Bis)', 105, yPos, { align: 'center' });
                    yPos += 15;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('PAYER INFORMATION:', 20, yPos);
                    yPos += 8;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Company: ${companyName}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Tax ID: ${companyTaxId}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Address: ${companyAddress}`, 20, yPos);
                    yPos += 12;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('PAYEE INFORMATION:', 20, yPos);
                    yPos += 8;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Name: ${employee.name}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Tax ID: ${employee.taxId}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Address: ${employee.address}`, 20, yPos);
                    yPos += 12;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('INCOME DETAILS:', 20, yPos);
                    yPos += 8;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Income Type: ${incomeTypeText}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Income Amount: ${formatCurrency(employee.income)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Tax Withheld: ${formatCurrency(employee.taxWithheld)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Tax Rate: ${((employee.taxWithheld / employee.income) * 100).toFixed(2)}%`, 20, yPos);
                    yPos += 15;
                    
                    const today = new Date().toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    doc.text(`Issue Date: ${today}`, 20, yPos);
                    yPos += 15;
                    
                    if (savedSignature) {
                        doc.addImage(savedSignature, 'PNG', 20, yPos, 50, 20);
                        yPos += 22;
                    }
                    doc.text('_________________________', 20, yPos);
                    yPos += 6;
                    doc.text('Authorized Signature', 20, yPos);
                    
                    doc.save(`50Tawi_${employee.name.replace(/\s+/g, '_')}.pdf`);
                    
                    // Update progress
                    const progress = Math.round(((i + 1) / csvData.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    
                    // Small delay between files
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                progressBar.style.display = 'none';
                showAlert('success', `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${csvData.length} ‡πÑ‡∏ü‡∏•‡πå) / All PDFs generated successfully! (${csvData.length} files)`);
                
            } catch (error) {
                progressBar.style.display = 'none';
                showAlert('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / Error: ' + error.message);
                console.error(error);
            }
        }
        
        // Auto-load company info on page load
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('companyInfo');
            if (saved) {
                loadCompanyInfo();
            }
        });
    </script>
</body>
</html>