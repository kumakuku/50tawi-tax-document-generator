<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡πÅ‡∏ö‡∏ö 50 ‡∏ó‡∏ß‡∏¥)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .form-section {
            padding: 40px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 15px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Sarabun', sans-serif;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .signature-pad {
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: #f8f9ff;
            cursor: crosshair;
            margin-top: 10px;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Sarabun', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 18px;
            margin-top: 30px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: #f0f3ff;
            border-color: #764ba2;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2e7d32;
            font-weight: 600;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #e65100;
        }

        @media (max-width: 768px) {
            .form-section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßæ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</h1>
            <p>‡πÅ‡∏ö‡∏ö 50 ‡∏ó‡∏ß‡∏¥ - ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏°‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£</p>
        </div>

        <div class="form-section">
            <div class="alert alert-info">
                <strong>üìã ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            </div>

            <!-- Company Information -->
            <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</div>
            
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (13 ‡∏´‡∏•‡∏±‡∏Å) *</label>
                <input type="text" id="companyTaxId" placeholder="0123456789012" maxlength="13" required>
            </div>

            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó *</label>
                <input type="text" id="companyName" placeholder="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î" required>
            </div>

            <div class="form-group">
                <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó *</label>
                <textarea id="companyAddress" placeholder="123 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡πÅ‡∏Ç‡∏ß‡∏á‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110" required></textarea>
            </div>

            <!-- Signature Section -->
            <div class="section-title">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div>
            
            <div class="form-group">
                <label>‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô *</label>
                <canvas id="signaturePad" class="signature-pad" width="600" height="200"></canvas>
                <div class="signature-controls">
                    <button type="button" class="btn btn-secondary" onclick="clearSignature()">‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                    <button type="button" class="btn btn-secondary" onclick="saveCompanyInfo()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div class="section-title">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
            
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV:</strong><br>
                <code>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢, ‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà, ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡πà‡∏ô, ‡∏õ‡∏µ‡∏†‡∏≤‡∏©‡∏µ</code>
            </div>

            <div class="file-upload" onclick="document.getElementById('csvFile').click()">
                <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
                <div>
                    <p style="font-size: 48px; margin-bottom: 10px;">üìÑ</p>
                    <p style="font-size: 16px; font-weight: 600; color: #667eea;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</p>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                </div>
            </div>

            <div id="fileInfo" class="file-info" style="display: none;"></div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>

            <button type="button" class="btn btn-success" id="generateBtn" onclick="generatePDFs()" disabled>
                üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
        </div>
    </div>

    <script>
        // Signature pad
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            isDrawing = true;
            [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        });

        canvas.addEventListener('touchend', () => {
            isDrawing = false;
        });

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveCompanyInfo() {
            const info = {
                taxId: document.getElementById('companyTaxId').value,
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                signature: canvas.toDataURL()
            };

            if (!info.taxId || !info.name || !info.address) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                return;
            }

            const signData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            if (!signData.some(channel => channel !== 0)) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô');
                return;
            }

            localStorage.setItem('companyInfo', JSON.stringify(info));
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function loadCompanyInfo() {
            const saved = localStorage.getItem('companyInfo');
            if (saved) {
                const info = JSON.parse(saved);
                document.getElementById('companyTaxId').value = info.taxId;
                document.getElementById('companyName').value = info.name;
                document.getElementById('companyAddress').value = info.address;
                
                if (info.signature) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0);
                    img.src = info.signature;
                }
            }
        }

        // CSV handling
        let csvData = [];

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .csv');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${file.name} (${csvData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                document.getElementById('generateBtn').disabled = false;
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                });
                csvData.push(row);
            }
        }

        // Generate PDFs
        async function generatePDFs() {
            const taxId = document.getElementById('companyTaxId').value;
            const name = document.getElementById('companyName').value;
            const address = document.getElementById('companyAddress').value;

            if (!taxId || !name || !address) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
                return;
            }

            if (csvData.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV');
                return;
            }

            const signData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            if (!signData.some(channel => channel !== 0)) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô');
                return;
            }

            const signature = canvas.toDataURL();
            const progress = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            
            progress.style.display = 'block';
            document.getElementById('generateBtn').disabled = true;

            const { jsPDF } = window.jspdf;

            for (let i = 0; i < csvData.length; i++) {
                const data = csvData[i];
                const pct = Math.round(((i + 1) / csvData.length) * 100);
                fill.style.width = pct + '%';
                fill.textContent = pct + '%';

                const pdf = new jsPDF('portrait', 'mm', 'a4');
                
                drawForm50Tawi(pdf, {
                    companyTaxId: taxId,
                    companyName: name,
                    companyAddress: address,
                    signature: signature,
                    name: data['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '',
                    idCard: data['‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '',
                    address: data['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '',
                    incomeType: data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] || '',
                    amount: data['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢'] || '0',
                    tax: data['‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å'] || '0',
                    date: data['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢'] || '',
                    seqNo: data['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà'] || '',
                    formType: data['‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡πà‡∏ô'] || '',
                    year: data['‡∏õ‡∏µ‡∏†‡∏≤‡∏©‡∏µ'] || ''
                });

                pdf.save(`50Tawi_${data['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'].replace(/\s+/g, '_')}.pdf`);
                await new Promise(r => setTimeout(r, 300));
            }

            fill.textContent = '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à!';
            setTimeout(() => {
                progress.style.display = 'none';
                fill.style.width = '0%';
                document.getElementById('generateBtn').disabled = false;
                alert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ${csvData.length} ‡∏â‡∏ö‡∏±‡∏ö`);
            }, 2000);
        }

        function drawForm50Tawi(pdf, d) {
            const w = 210, m = 15;
            let y = 15;

            // Header
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('WITHHOLDING TAX CERTIFICATE', w/2, y, {align: 'center'});
            y += 6;
            pdf.setFontSize(11);
            pdf.text('(Form 50 Tawi)', w/2, y, {align: 'center'});
            pdf.text('Copy 1', w-m, y, {align: 'right'});
            y += 5;
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            pdf.text('According to Section 50 Tawi of the Revenue Code', w/2, y, {align: 'center'});
            y += 10;

            // Payer
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text('PAYER:', m, y);
            y += 6;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            
            pdf.text('Tax ID:', m, y);
            const tx = m + 20;
            for (let i = 0; i < 13; i++) {
                pdf.rect(tx + i*6, y-4, 5, 6);
                if (i < d.companyTaxId.length) {
                    pdf.text(d.companyTaxId[i], tx + i*6 + 2.5, y, {align: 'center'});
                }
            }
            y += 10;
            pdf.text('Name: ' + d.companyName, m, y);
            y += 6;
            const addr1 = pdf.splitTextToSize('Address: ' + d.companyAddress, w - 2*m);
            pdf.text(addr1, m, y);
            y += addr1.length * 6 + 5;

            // Recipient
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text('RECIPIENT:', m, y);
            y += 6;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            
            pdf.text('ID:', m, y);
            for (let i = 0; i < 13; i++) {
                pdf.rect(tx + i*6, y-4, 5, 6);
                if (i < d.idCard.length) {
                    pdf.text(d.idCard[i], tx + i*6 + 2.5, y, {align: 'center'});
                }
            }
            y += 10;
            pdf.text('Name: ' + d.name, m, y);
            y += 6;
            const addr2 = pdf.splitTextToSize('Address: ' + d.address, w - 2*m);
            pdf.text(addr2, m, y);
            y += addr2.length * 6 + 5;

            // Income types with checkboxes
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text('INCOME TYPE:', m, y);
            y += 6;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);

            const types = [
                ['40(1)', 'Salary, wages, bonus'],
                ['40(2)', 'Fees, brokerage'],
                ['40(3)', 'Royalty, service fees'],
                ['40(4)(a)', 'Interest, dividend'],
                ['40(4)(b)', 'Interest'],
                ['40(5)', 'Taxable payment'],
                ['40(8)', 'Others']
            ];

            types.forEach(([code, desc]) => {
                pdf.rect(m, y-3, 3, 3);
                if (d.incomeType.includes(code)) {
                    pdf.text('X', m+1.5, y, {align: 'center'});
                }
                pdf.text(`Section ${code} ${desc}`, m+6, y);
                y += 5;
            });
            y += 3;

            // Payment table
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text('PAYMENT DETAILS:', m, y);
            y += 6;

            const c1=m, c2=m+45, c3=m+95, c4=m+145;
            const h=8;
            
            pdf.setFontSize(9);
            pdf.rect(c1, y, 45, h);
            pdf.rect(c2, y, 50, h);
            pdf.rect(c3, y, 50, h);
            pdf.rect(c4, y, w-m-c4, h);
            pdf.text('Date', c1+2, y+5);
            pdf.text('Amount', c2+2, y+5);
            pdf.text('Tax', c3+2, y+5);
            pdf.text('Remark', c4+2, y+5);
            
            y += h;
            pdf.setFont('helvetica', 'normal');
            pdf.rect(c1, y, 45, h);
            pdf.rect(c2, y, 50, h);
            pdf.rect(c3, y, 50, h);
            pdf.rect(c4, y, w-m-c4, h);
            pdf.text(d.date, c1+2, y+5);
            pdf.text(parseFloat(d.amount).toFixed(2), c2+2, y+5);
            pdf.text(parseFloat(d.tax).toFixed(2), c3+2, y+5);
            
            y += h;
            pdf.setFont('helvetica', 'bold');
            pdf.rect(c1, y, 45, h);
            pdf.rect(c2, y, 50, h);
            pdf.rect(c3, y, 50, h);
            pdf.rect(c4, y, w-m-c4, h);
            pdf.text('TOTAL', c1+2, y+5);
            pdf.text(parseFloat(d.amount).toFixed(2), c2+2, y+5);
            pdf.text(parseFloat(d.tax).toFixed(2), c3+2, y+5);

            y += h + 10;

            // Footer
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.text('Form: ' + d.formType, m, y);
            y += 6;
            pdf.text('Seq: ' + d.seqNo, m, y);
            y += 6;
            pdf.text('Year: ' + d.year, m, y);
            y += 10;

            // Signature
            pdf.text('_______________________', m + 100, y);
            if (d.signature) {
                try {
                    pdf.addImage(d.signature, 'PNG', m+100, y-8, 40, 10);
                } catch(e) {}
            }
            y += 5;
            pdf.text('Payer Signature', m + 100, y);
            y += 8;
            pdf.text('Date: __________', m + 100, y);
        }

        window.onload = loadCompanyInfo;
    </script>
</body>
</html>