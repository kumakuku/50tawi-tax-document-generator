<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°åœ‹ 50 Tawi å ±ç¨…æ–‡ä»¶æ‰¹æ¬¡ç”¢ç”Ÿå™¨ Pro</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #667eea;
            background: #f5f5f5;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Company Info Section */
        .company-form {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Upload Section */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }
        
        #fileInput {
            display: none;
        }
        
        /* Preview Section */
        .preview-section {
            margin-top: 30px;
            display: none;
        }
        
        .preview-section.show {
            display: block;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .preview-info {
            font-size: 1.1em;
            color: #333;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table tr:hover {
            background: #f5f5f5;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Signature Pad */
        .signature-section {
            margin-top: 30px;
        }
        
        .signature-container {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            text-align: center;
        }
        
        .signature-canvas {
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: crosshair;
            width: 100%;
            max-width: 600px;
            height: 200px;
            margin: 20px auto;
            display: block;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Status Messages */
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status.show {
            display: block;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Income Type Selector */
        .income-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .income-type-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .income-type-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        
        .income-type-card.selected {
            border-color: #667eea;
            background: #f0f2ff;
        }
        
        .income-type-card h4 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .income-type-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        /* PDF Preview */
        .pdf-preview {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .pdf-preview.show {
            display: block;
        }
        
        /* Tax Document Template */
        .tax-document {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            font-family: 'Courier New', monospace;
        }
        
        .doc-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .doc-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .doc-section {
            margin-bottom: 25px;
        }
        
        .doc-section-title {
            font-weight: bold;
            background: #f0f0f0;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .doc-field {
            display: flex;
            padding: 5px 0;
        }
        
        .doc-field-label {
            min-width: 200px;
            font-weight: 600;
        }
        
        .doc-field-value {
            flex: 1;
            border-bottom: 1px dotted #999;
        }
        
        .signature-area {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        
        .signature-box {
            text-align: center;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 60px;
            padding-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .signature-area {
                grid-template-columns: 1fr;
            }
        }
        
        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‡¹ğŸ‡­ æ³°åœ‹ 50 Tawi å ±ç¨…æ–‡ä»¶ç”¢ç”Ÿå™¨ Pro</h1>
            <p>æ‰¹æ¬¡ç”¢ç”Ÿå°ˆæ¥­ PDF æ ¼å¼å ±ç¨…æ–‡ä»¶ | PDF Generation | Digital Signature</p>
        </div>
        
        <div class="content">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('company')">ğŸ“‹ å…¬å¸è³‡è¨Š</button>
                <button class="tab" onclick="switchTab('upload')">ğŸ“¤ ä¸Šå‚³è³‡æ–™</button>
                <button class="tab" onclick="switchTab('signature')">âœï¸ æ•¸ä½ç°½ç« </button>
                <button class="tab" onclick="switchTab('generate')">ğŸ¯ ç”¢ç”Ÿæ–‡ä»¶</button>
            </div>
            
            <!-- Status Message -->
            <div id="statusMessage" class="status"></div>
            
            <!-- Tab 1: Company Info -->
            <div id="companyTab" class="tab-content active">
                <h2 style="margin-bottom: 20px;">å…¬å¸åŸºæœ¬è³‡è¨Šè¨­å®š</h2>
                <div class="company-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å…¬å¸åç¨± (Company Name) *</label>
                            <input type="text" id="companyName" placeholder="ä¾‹å¦‚: ABC Corporation Ltd.">
                        </div>
                        <div class="form-group">
                            <label>å…¬å¸ç¨…è™Ÿ (Tax ID) *</label>
                            <input type="text" id="companyTaxId" placeholder="0-1234-56789-01-2">
                        </div>
                        <div class="form-group">
                            <label>å…¬å¸åœ°å€ (Address) *</label>
                            <textarea id="companyAddress" placeholder="ä¾‹å¦‚: 123 Sukhumvit Road, Bangkok 10110"></textarea>
                        </div>
                        <div class="form-group">
                            <label>è¯çµ¡é›»è©± (Phone)</label>
                            <input type="text" id="companyPhone" placeholder="02-123-4567">
                        </div>
                        <div class="form-group">
                            <label>é›»å­éƒµä»¶ (Email)</label>
                            <input type="email" id="companyEmail" placeholder="hr@company.com">
                        </div>
                        <div class="form-group">
                            <label>æˆæ¬Šç°½ç½²äºº (Authorized Person) *</label>
                            <input type="text" id="authorizedPerson" placeholder="ä¾‹å¦‚: John Smith">
                        </div>
                        <div class="form-group">
                            <label>ç°½ç½²äººè·ä½ (Position)</label>
                            <input type="text" id="authorizedPosition" placeholder="ä¾‹å¦‚: Managing Director">
                        </div>
                        <div class="form-group">
                            <label>ç¨…å‹™å¹´åº¦ (Tax Year) *</label>
                            <input type="text" id="taxYear" placeholder="2026" value="2026">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveCompanyInfo()" style="margin-top: 20px;">
                        ğŸ’¾ å„²å­˜å…¬å¸è³‡è¨Š
                    </button>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">æ”¶å…¥é¡å‹è¨­å®š</h3>
                <p style="color: #666; margin-bottom: 20px;">é¸æ“‡æ­¤æ¬¡ç”¢ç”Ÿæ–‡ä»¶ä½¿ç”¨çš„é è¨­æ”¶å…¥é¡å‹</p>
                <div class="income-types">
                    <div class="income-type-card" onclick="selectIncomeType(1)">
                        <h4>1ï¸âƒ£ è–ªè³‡æ‰€å¾—</h4>
                        <p>Salary / à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™</p>
                    </div>
                    <div class="income-type-card" onclick="selectIncomeType(2)">
                        <h4>2ï¸âƒ£ çé‡‘ç´…åˆ©</h4>
                        <p>Bonus / à¹‚à¸šà¸™à¸±à¸ª</p>
                    </div>
                    <div class="income-type-card" onclick="selectIncomeType(3)">
                        <h4>3ï¸âƒ£ åŠ ç­è²»</h4>
                        <p>Overtime / à¸„à¹ˆà¸²à¸¥à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²</p>
                    </div>
                    <div class="income-type-card" onclick="selectIncomeType(4)">
                        <h4>4ï¸âƒ£ ä½£é‡‘</h4>
                        <p>Commission / à¸„à¹ˆà¸²à¸„à¸­à¸¡à¸¡à¸´à¸Šà¸Šà¸±à¹ˆà¸™</p>
                    </div>
                    <div class="income-type-card" onclick="selectIncomeType(5)">
                        <h4>5ï¸âƒ£ æ´¥è²¼è£œåŠ©</h4>
                        <p>Allowance / à¹€à¸šà¸µà¹‰à¸¢à¹€à¸¥à¸µà¹‰à¸¢à¸‡</p>
                    </div>
                    <div class="income-type-card" onclick="selectIncomeType(6)">
                        <h4>6ï¸âƒ£ å…¶ä»–æ”¶å…¥</h4>
                        <p>Other Income / à¸£à¸²à¸¢à¹„à¸”à¹‰à¸­à¸·à¹ˆà¸™à¹†</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Upload Data -->
            <div id="uploadTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ä¸Šå‚³å“¡å·¥è³‡æ–™ CSV</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">æ‹–æ›³ CSV æª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</div>
                    <div class="upload-hint">æ”¯æ´æ ¼å¼: .csv | æœ€å¤§ 10MB</div>
                    <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
                </div>
                
                <div class="preview-section" id="previewSection">
                    <div class="preview-header">
                        <div class="preview-info">
                            <strong>æª”æ¡ˆåç¨±:</strong> <span id="fileName"></span><br>
                            <strong>ç¸½ç­†æ•¸:</strong> <span id="recordCount"></span> ç­†
                        </div>
                        <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™</button>
                    </div>
                    
                    <h3>è³‡æ–™é è¦½ (å‰ 10 ç­†)</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="previewTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: Digital Signature -->
            <div id="signatureTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">æ•¸ä½ç°½ç« è¨­å®š</h2>
                <p style="color: #666; margin-bottom: 30px;">è«‹åœ¨ä¸‹æ–¹ç°½åæ¿ä¸Šç°½ç½²æ‚¨çš„ç°½åï¼Œæ­¤ç°½åå°‡è‡ªå‹•åŠ å…¥æ‰€æœ‰ç”¢ç”Ÿçš„æ–‡ä»¶ä¸­ã€‚</p>
                
                <div class="signature-section">
                    <div class="signature-container">
                        <h3>ç°½åæ¿</h3>
                        <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                        <div class="signature-controls">
                            <button class="btn btn-secondary" onclick="clearSignature()">ğŸ—‘ï¸ æ¸…é™¤ç°½å</button>
                            <button class="btn btn-primary" onclick="saveSignature()">ğŸ’¾ å„²å­˜ç°½å</button>
                        </div>
                        <p style="color: #999; margin-top: 15px; font-size: 0.9em;">
                            æç¤º: ä½¿ç”¨æ»‘é¼ æˆ–è§¸æ§ç­†åœ¨ç°½åæ¿ä¸Šç°½ç½²
                        </p>
                    </div>
                    
                    <div id="signaturePreview" style="display:none; margin-top: 30px; text-align: center;">
                        <h3>ç°½åé è¦½</h3>
                        <img id="signatureImage" style="max-width: 300px; border: 2px solid #e0e0e0; border-radius: 10px; margin-top: 15px;">
                    </div>
                </div>
            </div>
            
            <!-- Tab 4: Generate Documents -->
            <div id="generateTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ç”¢ç”Ÿ PDF æ–‡ä»¶</h2>
                
                <div style="background: #f9f9f9; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“Š ç”¢ç”Ÿå‰æª¢æŸ¥æ¸…å–®</h3>
                    <div style="display: grid; gap: 10px;">
                        <div id="checkCompany" style="padding: 10px; background: white; border-radius: 5px;">
                            â¬œ å…¬å¸è³‡è¨Šå·²è¨­å®š
                        </div>
                        <div id="checkData" style="padding: 10px; background: white; border-radius: 5px;">
                            â¬œ CSV è³‡æ–™å·²ä¸Šå‚³
                        </div>
                        <div id="checkSignature" style="padding: 10px; background: white; border-radius: 5px;">
                            â¬œ æ•¸ä½ç°½ç« å·²è¨­å®š (é¸å¡«)
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-primary" id="generateBtn" onclick="generatePDFs()" style="font-size: 1.2em; padding: 20px 40px;" disabled>
                        ğŸ“„ æ‰¹æ¬¡ç”¢ç”Ÿ PDF æ–‡ä»¶
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                
                <div id="generationLog" style="margin-top: 30px; display: none;">
                    <h3>ç”¢ç”Ÿè¨˜éŒ„</h3>
                    <div id="logContent" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-top: 15px; max-height: 400px; overflow-y: auto; font-family: monospace;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let csvData = [];
        let companyInfo = {};
        let selectedIncomeType = 1;
        let signaturePad;
        let signatureDataURL = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignaturePad();
            loadSavedCompanyInfo();
            checkReadiness();
            
            // Setup drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        });
        
        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Company Info Functions
        function saveCompanyInfo() {
            companyInfo = {
                name: document.getElementById('companyName').value,
                taxId: document.getElementById('companyTaxId').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                authorizedPerson: document.getElementById('authorizedPerson').value,
                authorizedPosition: document.getElementById('authorizedPosition').value,
                taxYear: document.getElementById('taxYear').value
            };
            
            // Validate required fields
            if (!companyInfo.name || !companyInfo.taxId || !companyInfo.address || !companyInfo.authorizedPerson || !companyInfo.taxYear) {
                showStatus('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ (æ¨™ç¤º * è€…)', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
            showStatus('âœ… å…¬å¸è³‡è¨Šå·²å„²å­˜', 'success');
            checkReadiness();
        }
        
        function loadSavedCompanyInfo() {
            const saved = localStorage.getItem('companyInfo');
            if (saved) {
                companyInfo = JSON.parse(saved);
                document.getElementById('companyName').value = companyInfo.name || '';
                document.getElementById('companyTaxId').value = companyInfo.taxId || '';
                document.getElementById('companyAddress').value = companyInfo.address || '';
                document.getElementById('companyPhone').value = companyInfo.phone || '';
                document.getElementById('companyEmail').value = companyInfo.email || '';
                document.getElementById('authorizedPerson').value = companyInfo.authorizedPerson || '';
                document.getElementById('authorizedPosition').value = companyInfo.authorizedPosition || '';
                document.getElementById('taxYear').value = companyInfo.taxYear || '2026';
            }
        }
        
        function selectIncomeType(type) {
            selectedIncomeType = type;
            document.querySelectorAll('.income-type-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.income-type-card').classList.add('selected');
            showStatus(`å·²é¸æ“‡æ”¶å…¥é¡å‹ ${type}`, 'info');
        }
        
        // File Upload Functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                showStatus('è«‹ä¸Šå‚³ CSV æ ¼å¼æª”æ¡ˆ', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showStatus('æª”æ¡ˆå¤§å°è¶…é 10MB é™åˆ¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result, file.name);
            };
            reader.readAsText(file);
        }
        
        function parseCSV(text, fileName) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                showStatus('CSV æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ç„¡è³‡æ–™', 'error');
                return;
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            csvData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    csvData.push(row);
                }
            }
            
            if (csvData.length === 0) {
                showStatus('CSV æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆè³‡æ–™', 'error');
                return;
            }
            
            displayPreview(fileName, headers);
            showStatus(`âœ… æˆåŠŸè¼‰å…¥ ${csvData.length} ç­†è³‡æ–™`, 'success');
            checkReadiness();
        }
        
        function displayPreview(fileName, headers) {
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('recordCount').textContent = csvData.length;
            
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // Create header
            tableHeader.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // Create rows (first 10)
            tableBody.innerHTML = '';
            const preview = csvData.slice(0, 10);
            preview.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            document.getElementById('previewSection').classList.add('show');
        }
        
        function clearData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å·²ä¸Šå‚³çš„è³‡æ–™å—ï¼Ÿ')) {
                csvData = [];
                document.getElementById('previewSection').classList.remove('show');
                document.getElementById('fileInput').value = '';
                showStatus('è³‡æ–™å·²æ¸…é™¤', 'info');
                checkReadiness();
            }
        }
        
        // Signature Functions
        function initializeSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            // Resize canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function resizeCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            signaturePad.clear();
        }
        
        function clearSignature() {
            signaturePad.clear();
            signatureDataURL = null;
            document.getElementById('signaturePreview').style.display = 'none';
            checkReadiness();
        }
        
        function saveSignature() {
            if (signaturePad.isEmpty()) {
                showStatus('è«‹å…ˆç°½ç½²å¾Œå†å„²å­˜', 'error');
                return;
            }
            
            signatureDataURL = signaturePad.toDataURL();
            document.getElementById('signatureImage').src = signatureDataURL;
            document.getElementById('signaturePreview').style.display = 'block';
            showStatus('âœ… ç°½åå·²å„²å­˜', 'success');
            checkReadiness();
        }
        
        // PDF Generation Functions
        async function generatePDFs() {
            if (csvData.length === 0) {
                showStatus('è«‹å…ˆä¸Šå‚³ CSV è³‡æ–™', 'error');
                return;
            }
            
            if (!companyInfo.name) {
                showStatus('è«‹å…ˆè¨­å®šå…¬å¸è³‡è¨Š', 'error');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ç”¢ç”Ÿä¸­...';
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const logContainer = document.getElementById('generationLog');
            const logContent = document.getElementById('logContent');
            
            progressContainer.classList.add('show');
            logContainer.style.display = 'block';
            logContent.innerHTML = '';
            
            const { jsPDF } = window.jspdf;
            
            for (let i = 0; i < csvData.length; i++) {
                const employee = csvData[i];
                const progress = Math.round(((i + 1) / csvData.length) * 100);
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                
                logContent.innerHTML += `[${i + 1}/${csvData.length}] ç”¢ç”Ÿ ${employee.employee_name} çš„æ–‡ä»¶...<br>`;
                logContent.scrollTop = logContent.scrollHeight;
                
                await generateSinglePDF(employee, jsPDF);
                
                // Small delay to allow UI update
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            btn.disabled = false;
            btn.innerHTML = 'ğŸ“„ æ‰¹æ¬¡ç”¢ç”Ÿ PDF æ–‡ä»¶';
            showStatus(`âœ… æˆåŠŸç”¢ç”Ÿ ${csvData.length} ä»½ PDF æ–‡ä»¶`, 'success');
            logContent.innerHTML += `<br><strong>âœ… å…¨éƒ¨å®Œæˆï¼å…±ç”¢ç”Ÿ ${csvData.length} ä»½æ–‡ä»¶</strong><br>`;
        }
        
        async function generateSinglePDF(employee, jsPDF) {
            const doc = new jsPDF();
            
            // Set font
            doc.setFont('helvetica');
            
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('THAILAND TAX WITHHOLDING CERTIFICATE', 105, 20, { align: 'center' });
            doc.text('à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­à¸£à¸±à¸šà¸£à¸­à¸‡à¸à¸²à¸£à¸«à¸±à¸à¸ à¸²à¸©à¸µ à¸“ à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢ (50 Tawi)', 105, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tax Year: ${companyInfo.taxYear}`, 105, 35, { align: 'center' });
            
            // Company Information Section
            let y = 45;
            doc.setFont('helvetica', 'bold');
            doc.text('PAYER INFORMATION / à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Company Name / à¸Šà¸·à¹ˆà¸­à¸šà¸£à¸´à¸©à¸±à¸—: ${companyInfo.name}`, 20, y);
            y += 6;
            doc.text(`Tax ID / à¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸œà¸¹à¹‰à¹€à¸ªà¸µà¸¢à¸ à¸²à¸©à¸µ: ${companyInfo.taxId}`, 20, y);
            y += 6;
            doc.text(`Address / à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ: ${companyInfo.address}`, 20, y);
            y += 6;
            if (companyInfo.phone) {
                doc.text(`Phone / à¹‚à¸—à¸£à¸¨à¸±à¸à¸—à¹Œ: ${companyInfo.phone}`, 20, y);
                y += 6;
            }
            
            // Employee Information Section
            y += 5;
            doc.setFont('helvetica', 'bold');
            doc.text('PAYEE INFORMATION / à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸£à¸±à¸šà¹€à¸‡à¸´à¸™', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Name / à¸Šà¸·à¹ˆà¸­: ${employee.employee_name || 'N/A'}`, 20, y);
            y += 6;
            doc.text(`Tax ID / à¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸œà¸¹à¹‰à¹€à¸ªà¸µà¸¢à¸ à¸²à¸©à¸µ: ${employee.tax_id || 'N/A'}`, 20, y);
            y += 6;
            doc.text(`Personal ID / à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™: ${employee.personal_id || 'N/A'}`, 20, y);
            y += 6;
            doc.text(`Address / à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ: ${employee.address || 'N/A'}`, 20, y);
            
            // Payment Information Section
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('PAYMENT DETAILS / à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Payment Date / à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢: ${employee.payment_date || 'N/A'}`, 20, y);
            y += 6;
            
            const incomeTypes = {
                1: 'Salary / à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™',
                2: 'Bonus / à¹‚à¸šà¸™à¸±à¸ª',
                3: 'Overtime / à¸„à¹ˆà¸²à¸¥à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²',
                4: 'Commission / à¸„à¹ˆà¸²à¸„à¸­à¸¡à¸¡à¸´à¸Šà¸Šà¸±à¹ˆà¸™',
                5: 'Allowance / à¹€à¸šà¸µà¹‰à¸¢à¹€à¸¥à¸µà¹‰à¸¢à¸‡',
                6: 'Other Income / à¸£à¸²à¸¢à¹„à¸”à¹‰à¸­à¸·à¹ˆà¸™à¹†'
            };
            
            doc.text(`Income Type / à¸›à¸£à¸°à¹€à¸ à¸—à¹€à¸‡à¸´à¸™à¹„à¸”à¹‰: ${incomeTypes[selectedIncomeType] || employee.income_type}`, 20, y);
            y += 6;
            doc.text(`Amount Paid / à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢: ${parseFloat(employee.amount_paid || 0).toFixed(2)} THB`, 20, y);
            y += 6;
            doc.text(`Tax Withheld / à¸ à¸²à¸©à¸µà¸«à¸±à¸ à¸“ à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢: ${parseFloat(employee.tax_withheld || 0).toFixed(2)} THB`, 20, y);
            y += 6;
            doc.text(`Social Security / à¸›à¸£à¸°à¸à¸±à¸™à¸ªà¸±à¸‡à¸„à¸¡: ${parseFloat(employee.social_security || 0).toFixed(2)} THB`, 20, y);
            y += 6;
            doc.text(`Provident Fund / à¸à¸­à¸‡à¸—à¸¸à¸™à¸ªà¸³à¸£à¸­à¸‡à¹€à¸¥à¸µà¹‰à¸¢à¸‡à¸Šà¸µà¸: ${parseFloat(employee.provident_fund || 0).toFixed(2)} THB`, 20, y);
            
            // Calculation Summary
            y += 10;
            const totalIncome = parseFloat(employee.amount_paid || 0);
            const totalDeductions = parseFloat(employee.social_security || 0) + parseFloat(employee.provident_fund || 0);
            const netIncome = totalIncome - totalDeductions;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY / à¸ªà¸£à¸¸à¸›', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Income / à¸£à¸²à¸¢à¹„à¸”à¹‰à¸£à¸§à¸¡: ${totalIncome.toFixed(2)} THB`, 20, y);
            y += 6;
            doc.text(`Total Deductions / à¸«à¸±à¸à¸£à¸§à¸¡: ${totalDeductions.toFixed(2)} THB`, 20, y);
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text(`Net Income / à¸£à¸²à¸¢à¹„à¸”à¹‰à¸ªà¸¸à¸—à¸˜à¸´: ${netIncome.toFixed(2)} THB`, 20, y);
            
            // Signature Section
            y += 15;
            doc.setFont('helvetica', 'bold');
            doc.text('CERTIFICATION / à¸à¸²à¸£à¸£à¸±à¸šà¸£à¸­à¸‡', 20, y);
            y += 8;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('I hereby certify that the information provided above is true and correct.', 20, y);
            doc.text('à¸‚à¹‰à¸²à¸à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸£à¸±à¸šà¸£à¸­à¸‡à¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¹‰à¸²à¸‡à¸•à¹‰à¸™à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸ˆà¸£à¸´à¸‡', 20, y + 5);
            
            y += 15;
            
            // Add signature if available
            if (signatureDataURL) {
                doc.addImage(signatureDataURL, 'PNG', 20, y, 50, 20);
            }
            
            y += 25;
            doc.line(20, y, 80, y);
            doc.text(`${companyInfo.authorizedPerson}`, 20, y + 5);
            doc.text(`${companyInfo.authorizedPosition || 'Authorized Person'}`, 20, y + 10);
            doc.text(`Date: ${new Date().toLocaleDateString('th-TH')}`, 20, y + 15);
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('This is a computer-generated document. No signature is required.', 105, 280, { align: 'center' });
            doc.text('à¹€à¸­à¸à¸ªà¸²à¸£à¸™à¸µà¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œ à¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™', 105, 285, { align: 'center' });
            
            // Save PDF
            const fileName = `50Tawi_${employee.employee_name}_${companyInfo.taxYear}.pdf`;
            doc.save(fileName);
        }
        
        // Check Readiness
        function checkReadiness() {
            const hasCompanyInfo = companyInfo.name && companyInfo.taxId && companyInfo.address && companyInfo.authorizedPerson;
            const hasData = csvData.length > 0;
            const hasSignature = signatureDataURL !== null;
            
            // Update checklist
            document.getElementById('checkCompany').innerHTML = hasCompanyInfo ? 
                'âœ… å…¬å¸è³‡è¨Šå·²è¨­å®š' : 'â¬œ å…¬å¸è³‡è¨Šå·²è¨­å®š';
            document.getElementById('checkData').innerHTML = hasData ? 
                'âœ… CSV è³‡æ–™å·²ä¸Šå‚³' : 'â¬œ CSV è³‡æ–™å·²ä¸Šå‚³';
            document.getElementById('checkSignature').innerHTML = hasSignature ? 
                'âœ… æ•¸ä½ç°½ç« å·²è¨­å®š (é¸å¡«)' : 'â¬œ æ•¸ä½ç°½ç« å·²è¨­å®š (é¸å¡«)';
            
            // Enable/disable generate button
            const generateBtn = document.getElementById('generateBtn');
            if (hasCompanyInfo && hasData) {
                generateBtn.disabled = false;
            } else {
                generateBtn.disabled = true;
            }
        }
        
        // Status Message
        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status ${type} show`;
            
            setTimeout(() => {
                status.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>